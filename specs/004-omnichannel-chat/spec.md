# Feature Specification: Omnichannel Chat Architecture

**Feature Branch**: `004-omnichannel-chat`
**Created**: 2025-12-27
**Status**: Draft
**Input**: User description: "Omnichannel Chat Architecture - единая система общения через Telegram, Web, WhatsApp, WeChat с общими credits и историей"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Telegram User with Web Access (Priority: P1)

Пользователь начинает общение в Telegram боте, затем хочет продолжить разговор через веб-интерфейс с сохранением всей истории и баланса credits.

**Why this priority**: Это основной сценарий (90% пользователей). Telegram — якорь идентификации, Web — дополнительный интерфейс.

**Independent Test**: Пользователь может зарегистрироваться в Telegram боте, затем войти на сайт через Telegram Login Widget и увидеть всю историю переписки и свой баланс credits.

**Acceptance Scenarios**:

1. **Given** пользователь зарегистрирован в Telegram боте и имеет историю сообщений, **When** он нажимает "Войти через Telegram" на сайте, **Then** он видит всю историю сообщений и свой баланс credits
2. **Given** пользователь авторизован на сайте через Telegram, **When** он отправляет сообщение с сайта, **Then** сообщение сохраняется в общую историю и отображается при следующем входе в Telegram бот
3. **Given** пользователь израсходовал credits на сайте, **When** он открывает Telegram бот, **Then** он видит обновлённый баланс credits

---

### User Story 2 - Real-time Conversation Sync (Priority: P1)

Пользователь получает ответы ассистента в реальном времени независимо от того, откуда отправил сообщение.

**Why this priority**: Критически важно для UX — пользователь ожидает мгновенной обратной связи.

**Independent Test**: Отправка сообщения через любой канал приводит к получению ответа в том же канале в реальном времени.

**Acceptance Scenarios**:

1. **Given** пользователь открыл веб-чат, **When** он отправляет сообщение, **Then** ответ ассистента появляется в том же окне без перезагрузки страницы
2. **Given** пользователь отправил сообщение в Telegram бот, **When** ассистент сформировал ответ, **Then** ответ приходит в Telegram, а не на сайт
3. **Given** пользователь открыл Telegram WebApp, **When** он отправляет сообщение, **Then** ответ приходит в WebApp в реальном времени

---

### User Story 3 - Web-only User Journey (Priority: P2)

Пользователь регистрируется через веб (email/OAuth) и использует сервис без Telegram, но видит предложение подключить Telegram для расширенных возможностей.

**Why this priority**: Edge case (10% пользователей), но важен для охвата аудитории без Telegram.

**Independent Test**: Пользователь может зарегистрироваться на сайте без Telegram, общаться с ассистентом и позже привязать Telegram аккаунт.

**Acceptance Scenarios**:

1. **Given** новый пользователь на сайте, **When** он регистрируется через email, **Then** он получает доступ к чату с ограниченными возможностями и видит предложение подключить Telegram
2. **Given** web-only пользователь с историей сообщений, **When** он подключает Telegram аккаунт, **Then** его credits и история объединяются с Telegram аккаунтом
3. **Given** web-only пользователь, **When** он находится офлайн, **Then** он не получает проактивные сообщения (напоминания, уведомления)

---

### User Story 4 - Telegram WebApp Experience (Priority: P2)

Пользователь открывает WebApp из Telegram бота и получает расширенный интерфейс с сохранением идентификации.

**Why this priority**: WebApp предоставляет богатый UI внутри Telegram экосистемы.

**Independent Test**: Пользователь нажимает кнопку в Telegram боте, открывает WebApp и продолжает общение с теми же credits и историей.

**Acceptance Scenarios**:

1. **Given** пользователь в Telegram боте, **When** он нажимает кнопку открытия WebApp, **Then** WebApp открывается с автоматической авторизацией (без повторного входа)
2. **Given** пользователь отправил сообщение в WebApp, **When** он закрывает WebApp и возвращается в бот, **Then** история содержит сообщение из WebApp
3. **Given** пользователь переключается между ботом и WebApp, **When** он проверяет баланс credits, **Then** баланс одинаковый в обоих интерфейсах

---

### User Story 5 - Proactive Messaging (Priority: P3)

Система отправляет проактивные сообщения (напоминания, уведомления, engagement) только пользователям с подключённым мессенджером.

**Why this priority**: Engagement-функция, важная для retention, но требует наличия мессенджера.

**Independent Test**: Система может отправить проактивное сообщение пользователю в Telegram и не пытается отправить web-only пользователям.

**Acceptance Scenarios**:

1. **Given** пользователь с подключённым Telegram давно не заходил, **When** срабатывает триггер engagement, **Then** пользователь получает сообщение в Telegram бот
2. **Given** web-only пользователь, **When** срабатывает триггер engagement, **Then** система не отправляет сообщение (нет канала доставки)
3. **Given** пользователь заблокировал бота, **When** система пытается отправить сообщение, **Then** система корректно обрабатывает ошибку и помечает пользователя как неактивного

---

### User Story 6 - Account Linking via Command (Priority: P3)

Пользователь Telegram может сгенерировать ссылку для привязки веб-аккаунта.

**Why this priority**: Альтернативный способ привязки для сложных случаев.

**Independent Test**: Команда /link в боте генерирует одноразовую ссылку, которую можно открыть в браузере для привязки аккаунтов.

**Acceptance Scenarios**:

1. **Given** пользователь в Telegram боте, **When** он отправляет /link, **Then** он получает уникальную ссылку с ограниченным сроком действия (10 минут)
2. **Given** пользователь открыл ссылку привязки в браузере, **When** он авторизован на сайте, **Then** аккаунты связываются и отображается подтверждение
3. **Given** срок действия ссылки истёк, **When** пользователь открывает ссылку, **Then** он видит сообщение об истечении срока и предложение сгенерировать новую

---

### Edge Cases

- Что происходит, когда пользователь пытается привязать Telegram к аккаунту, который уже привязан к другому Telegram? → Отклонение с объяснением
- Как система обрабатывает одновременные сообщения из разных каналов? → Каждое сообщение обрабатывается независимо, ответы идут в соответствующие каналы
- Что происходит при объединении аккаунтов с credits? → Credits суммируются при слиянии
- Как обрабатываются сбои доставки сообщений? → Retry с exponential backoff, после исчерпания попыток — статус failed
- Что если внешний API мессенджера недоступен? → Retry логика, сообщения остаются в очереди

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система ДОЛЖНА поддерживать единую идентификацию пользователя через Telegram ID как первичный идентификатор (anchor)
- **FR-002**: Система ДОЛЖНА позволять пользователям авторизоваться на веб через Telegram Login Widget
- **FR-003**: Система ДОЛЖНА хранить единую историю сообщений независимо от канала отправки
- **FR-004**: Система ДОЛЖНА маршрутизировать ответы в тот же канал и интерфейс, откуда пришло сообщение
- **FR-005**: Система ДОЛЖНА поддерживать shared credits между всеми связанными каналами пользователя
- **FR-006**: Система ДОЛЖНА отправлять проактивные сообщения только через мессенджеры (не веб)
- **FR-007**: Система ДОЛЖНА обеспечивать доставку сообщений в реальном времени через механизм подписок
- **FR-008**: Система ДОЛЖНА криптографически верифицировать данные авторизации от Telegram
- **FR-009**: Система ДОЛЖНА поддерживать объединение аккаунтов при привязке Telegram к существующему web-аккаунту
- **FR-010**: Система ДОЛЖНА автоматически повторять неудачные попытки доставки сообщений с exponential backoff
- **FR-011**: Система ДОЛЖНА поддерживать одновременную работу через Telegram бот и Telegram WebApp как разные интерфейсы одного канала
- **FR-012**: Система ДОЛЖНА различать канал (identity) и интерфейс (delivery method) в каждом сообщении
- **FR-013**: Система ДОЛЖНА мигрировать существующие данные пользователей из текущей схемы в новую unified-схему
- **FR-014**: Система ДОЛЖНА поддерживать обязательную авторизацию на всех каналах (без анонимного доступа)
- **FR-015**: Система ДОЛЖНА уведомлять web-only пользователей о преимуществах подключения Telegram

### Key Entities

- **Unified User**: Единая запись пользователя, объединяющая идентификаторы из всех каналов (Telegram ID, Web auth ID, WhatsApp phone, WeChat OpenID). Telegram ID — первичный якорь.
- **Conversation**: Сессия чата с определённой персоной (Arina/Cassandra), содержит контекст для LLM и накопленную историю.
- **Message**: Отдельное сообщение в разговоре с указанием канала отправки, интерфейса, роли (user/assistant/system) и типа контента.
- **Message Delivery**: Запись о статусе доставки конкретного сообщения в конкретный канал/интерфейс для retry-логики.
- **Link Token**: Одноразовый токен для привязки аккаунтов между каналами с ограниченным сроком действия.
- **User Credits**: Баланс credits пользователя (basic, pro, cassandra), единый для всех каналов.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователи могут войти на сайт через Telegram за менее чем 10 секунд (от клика до авторизации)
- **SC-002**: Синхронизация сообщений между каналами происходит в реальном времени (задержка менее 2 секунд)
- **SC-003**: 99% сообщений успешно доставляются с первой попытки при нормальной работе внешних сервисов
- **SC-004**: Время миграции существующих пользователей не превышает 30 минут при 10,000 записей
- **SC-005**: 95% пользователей Telegram, открывающих WebApp, автоматически авторизуются без дополнительных действий
- **SC-006**: Web-only пользователи видят предложение подключить Telegram при каждом визите до момента подключения
- **SC-007**: Система поддерживает 1,000 одновременных подключений в реальном времени без деградации производительности
- **SC-008**: При объединении аккаунтов 100% credits и истории сообщений сохраняются
- **SC-009**: Retry-логика восстанавливает доставку 95% временно неудачных сообщений
- **SC-010**: Пользователи могут переключаться между каналами без потери контекста разговора

## Assumptions

- Telegram остаётся основным мессенджером для целевой аудитории (РФ/СНГ)
- Пользователи предпочитают единую точку входа через Telegram Login Widget
- Web-версия является дополнительным каналом, а не основным
- WhatsApp и WeChat будут добавлены в будущих итерациях, схема должна их поддерживать
- Существующие данные в таблицах profiles, chat_messages, user_credits можно мигрировать без потерь

## Out of Scope

- Интеграция с WhatsApp (Future P2)
- Интеграция с WeChat (Future P2)
- Интеграция с Viber (Future P3)
- Анонимный доступ без регистрации
- Push-уведомления в браузере (только мессенджеры)
- Кросс-канальная доставка (сообщение из Telegram → ответ в Web)
