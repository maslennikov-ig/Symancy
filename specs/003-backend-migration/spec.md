# Feature Specification: Backend Migration (n8n to Node.js)

**Feature Branch**: `003-backend-migration`
**Created**: 2025-12-25
**Status**: Draft
**Input**: User description: "Создай спецификацию для реализации backend-миграции Telegram-бота Symancy с n8n на Node.js"

## Executive Summary

Миграция существующего Telegram-бота Symancy с low-code платформы n8n на полноценный Node.js backend. Бот анализирует кофейную гущу с использованием AI (Vision + LLM) и поддерживает 5 режимов взаимодействия с пользователями.

**Бизнес-проблемы, решаемые миграцией:**
- n8n требует отдельного хостинга/подписки
- Сложность отладки визуального workflow
- Отсутствие версионирования кода
- Ограниченная гибкость для 5 режимов взаимодействия

**Целевой результат:** Модульный Node.js backend, использующий существующую инфраструктуру Supabase PostgreSQL.

---

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Photo Analysis (Arina Basic) (Priority: P1)

Пользователь отправляет фото кофейной чашки в Telegram-бот и получает психологическую интерпретацию от персонажа Арина (психолог-консультант) на основе распознанных паттернов в кофейной гуще.

**Why this priority**: Это основная функциональность бота, 80% использования приходится на этот сценарий. Без работающего анализа фото бот не имеет ценности.

**Independent Test**: Можно протестировать отправкой любого фото кофейной чашки в бота. Пользователь получает осмысленный психологический анализ в течение 30 секунд.

**Acceptance Scenarios**:

1. **Given** пользователь имеет активный кредит (basic), **When** отправляет фото кофейной чашки, **Then** получает сообщение "Смотрю в гущу..." и через 10-30 секунд — психологический анализ от Арины
2. **Given** пользователь отправил фото, **When** бот распознает паттерны на изображении, **Then** интерпретация содержит конкретные символы и их психологическое значение
3. **Given** пользователь не имеет кредитов, **When** отправляет фото, **Then** получает сообщение о необходимости пополнения с кнопкой перехода к оплате
4. **Given** у пользователя уже обрабатывается предыдущее фото, **When** отправляет новое фото, **Then** получает сообщение "Я ещё читаю твою предыдущую чашку..."

---

### User Story 2 - Chat / Follow-up (Priority: P2)

Пользователь задает текстовые вопросы боту после получения анализа, чтобы уточнить интерпретацию или получить дополнительные советы. Бот помнит контекст предыдущих анализов и разговора.

**Why this priority**: Follow-up вопросы создают engagement и помогают пользователю глубже понять интерпретацию. Это бесплатная функция, увеличивающая retention.

**Independent Test**: После получения анализа можно задать вопрос "Что значит символ сердца?" и получить контекстный ответ, связанный с предыдущим анализом.

**Acceptance Scenarios**:

1. **Given** пользователь получил анализ фото, **When** задает текстовый вопрос по теме анализа, **Then** получает ответ, учитывающий контекст последнего анализа и истории переписки
2. **Given** пользователь не отправлял фото (новый пользователь), **When** задает вопрос, **Then** бот отвечает в роли Арины без контекста анализа
3. **Given** пользователь отправил 50 сообщений за сегодня (лимит), **When** отправляет 51-е сообщение, **Then** получает уведомление о достижении дневного лимита

---

### User Story 3 - Onboarding (Priority: P3)

Новый пользователь проходит интерактивное знакомство с ботом: вводит имя, выбирает цели использования, настраивает уведомления. После завершения получает бонусный кредит на первый анализ.

**Why this priority**: Onboarding улучшает first-time experience и собирает данные для персонализации. Однако бот работоспособен и без него — пользователь может сразу отправить фото.

**Independent Test**: Команда /start запускает пошаговый диалог. Каждый шаг тестируется отдельно: ввод имени, выбор целей (inline keyboard), настройка уведомлений.

**Acceptance Scenarios**:

1. **Given** новый пользователь (первый запуск), **When** отправляет /start, **Then** получает приветственное сообщение и вопрос "Как тебя зовут?"
2. **Given** пользователь ввел имя, **When** бот получает текст, **Then** сохраняет имя и показывает inline keyboard с выбором целей (карьера, отношения, здоровье и др.)
3. **Given** пользователь выбрал цели, **When** нажимает кнопку, **Then** бот спрашивает о частоте уведомлений (ежедневно, еженедельно, никогда)
4. **Given** пользователь завершил все шаги, **When** выбирает частоту уведомлений, **Then** получает 1 бонусный кредит и сообщение о готовности к первому анализу
5. **Given** пользователь прервал onboarding (вышел из чата), **When** возвращается через 24 часа, **Then** получает напоминание завершить регистрацию

---

### User Story 4 - Cassandra Premium Analysis (Priority: P4)

Пользователь запрашивает премиум-анализ от персонажа Кассандра (мистический оракул). Анализ глубже, стиль — эзотерический, используются более мощные AI модели.

**Why this priority**: Премиум-функция для монетизации. Работает аналогично basic анализу, но с другими промптами и моделями.

**Independent Test**: Отправка фото с caption "cassandra" или команда /cassandra + фото активирует премиум режим.

**Acceptance Scenarios**:

1. **Given** пользователь имеет cassandra credit, **When** отправляет фото с caption "cassandra" или "premium", **Then** получает расширенный анализ в мистическом стиле от Кассандры
2. **Given** пользователь вызвал /cassandra, **When** отправляет следующее фото, **Then** это фото обрабатывается как cassandra-анализ
3. **Given** пользователь не имеет cassandra credits, **When** запрашивает premium анализ, **Then** получает предложение приобрести премиум-пакет

---

### User Story 5 - Proactive Engagement (Priority: P5)

Бот самостоятельно отправляет пользователям сообщения: напоминания неактивным пользователям, еженедельные check-in, ежедневные предсказания (для подписчиков).

**Why this priority**: Увеличивает retention и LTV. Реализуется после основных режимов, так как не влияет на core функциональность.

**Independent Test**: Scheduled job отправляет сообщение пользователю, неактивному 7 дней. Можно проверить вручную, изменив last_interaction_at.

**Acceptance Scenarios**:

1. **Given** пользователь неактивен 7 дней, **When** наступает 10:00 MSK, **Then** пользователь получает сообщение "Давно не виделись!"
2. **Given** наступил понедельник 10:00 MSK, **When** у пользователя был анализ на прошлой неделе, **Then** пользователь получает сообщение "Как дела с рекомендациями?"
3. **Given** пользователь подписан на ежедневные предсказания, **When** наступает утро, **Then** пользователь получает короткое "предсказание дня"
4. **Given** пользователь не завершил onboarding 24 часа назад, **When** наступает scheduled time, **Then** получает напоминание продолжить регистрацию

---

### Edge Cases

- **Невалидное фото**: Если Vision API не может распознать паттерны (темное фото, не чашка), пользователь получает сообщение "Не могу разглядеть гущу. Сделай фото ближе" и кредит не списывается
- **Таймаут LLM**: При таймауте Vision/Interpretation API (>30 секунд) — 3 retry, затем сообщение "Духи молчат..." и возврат кредита
- **Длинный ответ**: Если ответ LLM превышает 4096 символов (лимит Telegram), он разбивается на части с корректным HTML-форматированием и отправляется с задержкой 500ms
- **Параллельные фото**: Если пользователь отправляет несколько фото подряд — обрабатывается только первое, остальные игнорируются с уведомлением
- **Rate limit Telegram**: При достижении rate limit — pg-boss автоматически замедляет отправку
- **Недоступность OpenRouter**: Fallback на альтернативную модель (настраивается в system_config)

---

## Requirements *(mandatory)*

### Functional Requirements

#### Core Functionality

- **FR-001**: Система MUST принимать фото через Telegram webhook и помещать в очередь обработки
- **FR-002**: Система MUST распознавать паттерны на изображении кофейной гущи с использованием Vision AI
- **FR-003**: Система MUST генерировать психологическую интерпретацию на основе распознанных паттернов
- **FR-004**: Система MUST отправлять интерпретацию пользователю в Telegram с корректным HTML-форматированием
- **FR-005**: Система MUST списывать кредиты атомарно только после успешного анализа
- **FR-006**: Система MUST возвращать кредит при неудачном анализе (API ошибки, невалидное фото)

#### Memory & Context

- **FR-007**: Система MUST сохранять историю сообщений (user/assistant) в PostgreSQL
- **FR-008**: Система MUST загружать последние 20 сообщений для контекста при chat-ответах
- **FR-009**: Система MUST включать последний анализ в контекст chat-ответов
- **FR-010**: Система MUST отслеживать состояние пользователя (idle, onboarding, processing)

#### State Management

- **FR-011**: Система MUST проводить новых пользователей через onboarding flow (имя → цели → уведомления)
- **FR-012**: Система MUST сохранять состояние onboarding при прерывании и восстанавливать при возврате
- **FR-013**: Система MUST блокировать параллельную обработку фото от одного пользователя

#### Proactive Features

- **FR-014**: Система MUST отправлять scheduled сообщения по расписанию (cron jobs)
- **FR-015**: Система MUST поддерживать разные типы scheduled сообщений: inactive_reminder, weekly_checkin, daily_fortune
- **FR-016**: Система MUST учитывать часовой пояс пользователя (по умолчанию Europe/Moscow)

#### Configuration

- **FR-017**: Система MUST позволять изменять модели LLM без перезапуска (через database config)
- **FR-018**: Система MUST поддерживать retry с backoff и fallback на альтернативные модели
- **FR-019**: Система MUST логировать все ошибки и важные события структурированно (JSON)

#### Limits & Quotas

- **FR-020**: Система MUST ограничивать бесплатные chat-сообщения до 50 в день на пользователя
- **FR-021**: Система MUST сбрасывать дневной счетчик сообщений в полночь по часовому поясу пользователя

### Key Entities

- **User**: Telegram-пользователь с профилем (имя, цели, настройки уведомлений, часовой пояс)
- **Chat Message**: Сообщение в истории переписки (role: user/assistant/system, content, type, metadata)
- **User State**: Текущее состояние пользователя в flow (mode: idle/onboarding/processing, step, buffer_data)
- **Analysis**: Результат анализа фото (vision_result, interpretation, persona, created_at)
- **Scheduled Message**: Запланированное сообщение (type, scheduled_for, status, payload)
- **System Config**: Динамическая конфигурация (model_vision, model_arina, chat_daily_limit и др.)
- **User Credits**: Баланс кредитов пользователя (basic_credits, cassandra_credits)

---

## Non-Functional Requirements

### Performance

- **NFR-001**: Время ответа webhook MUST быть <200ms (синхронная часть)
- **NFR-002**: Полный цикл анализа фото MUST занимать <30 секунд
- **NFR-003**: Система MUST обрабатывать минимум 100 одновременных пользователей

### Reliability

- **NFR-004**: Система MUST не терять сообщения при перезапуске (persisted job queue)
- **NFR-005**: Система MUST retry неудачные API-запросы 3 раза с exponential backoff
- **NFR-006**: Система MUST иметь health check endpoint для мониторинга

### Security

- **NFR-007**: Все credentials MUST храниться в environment variables
- **NFR-008**: Database MUST использовать RLS policies для изоляции данных пользователей
- **NFR-009**: Telegram webhook MUST валидировать secret token

### Maintainability

- **NFR-010**: Код MUST быть написан на TypeScript со strict mode
- **NFR-011**: Все модули MUST следовать структуре Modular Monolith
- **NFR-012**: Система MUST иметь structured logging (JSON) для production

---

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Пользователь получает анализ фото в течение 30 секунд после отправки (95 перцентиль)
- **SC-002**: Система корректно обрабатывает 100+ одновременных запросов без деградации
- **SC-003**: 99% webhook-запросов отвечают в течение 200ms
- **SC-004**: 0% потерь сообщений при плановом перезапуске бота
- **SC-005**: 100% credit-транзакций атомарны (кредит списывается только при успешном анализе)
- **SC-006**: Новый пользователь завершает onboarding за менее чем 2 минуты
- **SC-007**: Длинные ответы (>4096 символов) корректно разбиваются без потери форматирования
- **SC-008**: Scheduled сообщения отправляются с точностью +/- 5 минут от запланированного времени

### Migration Success Criteria

- **SC-009**: Все 5 режимов взаимодействия работают идентично n8n-версии
- **SC-010**: Существующие пользователи не теряют историю и кредиты при миграции
- **SC-011**: Папка n8n/ удалена из репозитория
- **SC-012**: Backend работает в Docker-контейнере на production сервере
- **SC-013**: Health check проходит успешно после деплоя

---

## Assumptions

1. **Supabase остается основной базой данных** — существующие таблицы (profiles, user_credits, purchases) переиспользуются
2. **OpenRouter — единственный LLM провайдер** — все модели доступны через единый API
3. **Telegram Bot API webhook** — не polling, webhook на HTTPS endpoint
4. **Один процесс** — API и workers в одном процессе (MODE=BOTH), не microservices
5. **Europe/Moscow по умолчанию** — для scheduled сообщений, если пользователь не указал timezone
6. **Дневной лимит 50 chat сообщений** — бесплатно, после — premium или ожидание следующего дня

---

## Out of Scope

1. **LangChain Agents** — отложено до Phase 3+, текущая реализация использует Chains и StateGraph
2. **Telegram Mini App** — интеграция с TMA не входит в этот spec
3. **Referral система** — вирусность и социальные функции — следующий spec
4. **Web interface для анализа** — только Telegram bot
5. **Многоязычность бота** — только русский язык для MVP
6. **Analytics dashboard** — внутренняя аналитика не входит в scope

---

## Dependencies

1. **Supabase PostgreSQL** — существующая база данных с таблицами profiles, user_credits, purchases
2. **OpenRouter API** — доступ к моделям Google Gemini, OpenAI, Anthropic
3. **Telegram Bot API** — webhook URL на production сервере
4. **Docker** — для deployment на production сервер (91.132.59.194)
5. **Существующие промпты** — переиспользование промптов из n8n workflow

---

## Clarifications

### Session 2025-12-25
- Q: Стратегия логирования стоимости LLM-запросов? → A: Сохранять cost в `chat_messages.metadata` с полями `tokens_used`, `cost_usd`, `model_used` с привязкой к `user_id`. Агрегация для админки (LLM Cost Analytics per user) — отложена до реализации Admin Panel (см. `docs/ADMIN_PANEL_SPEC.md`).
- Q: Поведение при graceful shutdown mid-processing? → A: TTL на `processing` mode — автоматическая очистка stale locks (>5 минут) при startup worker'а. Job в pg-boss сохраняется и будет reprocessed.
- Q: Стратегия хранения фото? → A: Локальное хранение на сервере `/var/data/symancy/photos/{user_id}/{analysis_id}.webp`. Retention по типу анализа: basic=7 дней, pro=30 дней, cassandra=90 дней. Метаданные (`photo_path`, `retention_until`) в `chat_messages.metadata`. Ежедневный pg-boss cron job для очистки expired фото.
- Q: Alerting strategy для критических ошибок? → A: Telegram alerts в админ-чат. Триггеры: Vision API errors (>3 за 5 мин), pg-boss queue backlog (>50 jobs), worker crashes, credit transaction failures. Реализация: отдельный Telegram chat ID в env (`ADMIN_CHAT_ID`).
- Q: Observability/Metrics стратегия для production? → A: Отложить на Phase 6 (Production Hardening). MVP: Pino JSON structured logging + `/health` endpoint. Prometheus/Grafana добавить позже без изменения кода.
