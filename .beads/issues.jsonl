{"id":"sym-157","title":"Переключить YooKassa в боевой режим","description":"## Что сделать\n1. В личном кабинете YooKassa перевести магазин из тестового в боевой режим\n2. Получить боевые credentials (shop_id, secret_key)\n3. Установить секреты в Supabase:\n   ```bash\n   supabase secrets set YUKASSA_SHOP_ID=xxx YUKASSA_SECRET_KEY=xxx\n   ```\n4. Настроить webhook URL в боевом магазине YooKassa:\n   ```\n   https://johspxgvkbrysxhilmbg.supabase.co/functions/v1/payment-webhook\n   ```\n5. Включить события: payment.succeeded, payment.canceled\n\n## Зависимости\n- sym-20s (деплой create-payment)\n- sym-8kh (уточнение налогов)","status":"open","priority":1,"issue_type":"task","owner":"your-email@example.com","created_at":"2026-02-04T15:58:28.012265753+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:58:28.012265753+03:00"}
{"id":"sym-20s","title":"Задеплоить create-payment edge function","description":"## Что сделать\nЗадеплоить обновлённую edge function create-payment с фискальными чеками:\n\n```bash\nsupabase functions deploy create-payment\n```\n\n## Проверка после деплоя\n1. Тестовая оплата картой 2202 4743 0132 2987 (успешная)\n2. В дашборде YooKassa проверить что чек прикреплён к платежу\n3. На email должен прийти фискальный чек\n4. Тестовая оплата картой 2200 0000 0000 0053 (недостаточно средств) — чек НЕ должен генерироваться\n\n## Зависимости\n- sym-dd0 (фискальные чеки) — готово\n- sym-8kh (уточнение налогов) — желательно до продакшна","status":"open","priority":1,"issue_type":"task","owner":"your-email@example.com","created_at":"2026-02-04T15:58:19.900231957+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:58:19.900231957+03:00"}
{"id":"sym-4mr","title":"Тестирование платежей на продакшне","description":"## Чеклист\nПосле перехода в боевой режим протестировать:\n\n- [ ] Успешная оплата реальной картой (минимальный тариф 100₽)\n- [ ] Фискальный чек приходит на email\n- [ ] Кредиты начисляются на аккаунт\n- [ ] PaymentResult показывает правильный статус\n- [ ] Отмена платежа — причина отображается корректно\n- [ ] 3D Secure — пользователь возвращается и видит результат\n- [ ] Webhook обрабатывается корректно (проверить логи)\n- [ ] Повторный webhook не дублирует кредиты (идемпотентность)\n\n## Зависимости\n- sym-157 (переключение в боевой режим)","status":"open","priority":1,"issue_type":"task","owner":"your-email@example.com","created_at":"2026-02-04T15:58:43.777929904+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:58:43.777929904+03:00"}
{"id":"sym-60n","title":"PaymentResult: авто-определение статуса из БД","description":"## Проблема\nДетализированные сообщения об отмене платежей (sym-m2s) никогда не показывались пользователям. PaymentResult.tsx ожидал параметр status=canceled в URL, но виджет YooKassa его не передаёт.\n\n## Причина\n- PaymentWidget.tsx хардкодит return_url с status=success\n- При 3D Secure редиректе — URL без параметра status → показывается 'unknown'\n- Документация YooKassa подтверждает: события success/fail не работают при наличии return_url\n\n## Решение\n- Авто-определение статуса из БД когда URL-параметр status отсутствует\n- Добавлен pending-статус с поллингом (3с интервал, макс 10 попыток)\n- i18n для pending-статуса (3 языка)\n- 8 новых тестов (всего 42)\n\n## Коммит\n79075b1 → v0.6.15","status":"closed","priority":1,"issue_type":"bug","owner":"your-email@example.com","created_at":"2026-02-04T15:57:43.97552302+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:57:48.505748361+03:00","closed_at":"2026-02-04T15:57:48.505748361+03:00","close_reason":"Реализовано в v0.6.15. PaymentResult теперь определяет статус из purchases при отсутствии URL-параметра. Pending-поллинг, 42 теста проходят."}
{"id":"sym-8kh","title":"Уточнить систему налогообложения с бухгалтером","description":"## Что нужно\nУточнить у бухгалтера:\n1. Система налогообложения (УСН доходы / УСН доходы-расходы / ОСН / другая)\n2. Ставка НДС (Без НДС / НДС 20% / другая)\n\n## Где менять\nsupabase/functions/create-payment/index.ts:\n- RECEIPT_TAX_SYSTEM_CODE (сейчас 2 = УСН доходы)\n- RECEIPT_VAT_CODE (сейчас 1 = Без НДС)\n\n## Контекст\nПараметры влияют на фискальные чеки (54-ФЗ), отправляемые через YooKassa.","status":"open","priority":2,"issue_type":"chore","owner":"your-email@example.com","created_at":"2026-02-04T15:58:11.113733064+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:58:11.113733064+03:00"}
{"id":"sym-dd0","title":"Фискальные чеки 54-ФЗ в YooKassa","description":"## Проблема\ncreate-payment edge function создаёт платежи без поля receipt. По закону 54-ФЗ каждый онлайн-платёж обязан генерировать фискальный чек. Блокирует запуск в продакшн.\n\n## Решение\nДобавлено поле receipt в payload YooKassa (inline-подход). YooKassa автоматически генерирует чек при успешной оплате.\n\n- customer.email — из JWT (user.email)\n- items[].description — название тарифа\n- payment_mode: full_payment, payment_subject: service\n- tax_system_code: 2 (УСН доходы) — вынесено в константу\n- vat_code: 1 (Без НДС) — вынесено в константу\n\n## Файл\nsupabase/functions/create-payment/index.ts","status":"closed","priority":1,"issue_type":"feature","owner":"your-email@example.com","created_at":"2026-02-04T15:57:57.991374459+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:58:03.376042666+03:00","closed_at":"2026-02-04T15:58:03.376042666+03:00","close_reason":"Реализовано. Поле receipt добавлено в create-payment/index.ts с inline-чеком YooKassa. Налоговые параметры вынесены в константы (RECEIPT_TAX_SYSTEM_CODE, RECEIPT_VAT_CODE). Ожидает деплой и подтверждение бухгалтера."}
{"id":"sym-m2s","title":"Детализированные сообщения об отмене платежей","description":"## Описание\nДобавлены детализированные причины отмены платежей YooKassa. 12 причин отмены с переводами на 3 языка (ru, en, zh).\n\n## Реализация\n- Типы CancellationReason и CancellationParty в src/types/payment.ts\n- Маппинг причин на i18n-ключи в src/constants/payment.ts\n- Миграции: cancellation_reason и cancellation_party в таблице purchases\n- Обработка в payment-webhook edge function\n- Компонент PaymentCancellationStats для админ-панели\n- 61 тест\n\n## Коммит\ndf21207 feat(payments): add detailed cancellation reason messages","status":"closed","priority":2,"issue_type":"feature","owner":"your-email@example.com","created_at":"2026-02-04T15:57:28.173791014+03:00","created_by":"Igor Maslennikov","updated_at":"2026-02-04T15:57:33.492697116+03:00","closed_at":"2026-02-04T15:57:33.492697116+03:00","close_reason":"Реализовано в коммите df21207. 12 причин отмены YooKassa с i18n (3 языка), миграции БД, webhook handler, админ-панель, 61 тест."}
