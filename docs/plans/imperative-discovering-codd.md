# Plan: Add fiscal receipt data (54-FZ) to YooKassa payments

## Problem

The `create-payment` edge function creates payments without fiscal receipt data. Russian law 54-FZ requires every online payment to generate a fiscal receipt. Without the `receipt` field, YooKassa won't generate receipts, which blocks production deployment.

## Context

- YooKassa supports **inline receipts** — pass `receipt` field in `POST /v3/payments` and YooKassa auto-generates the fiscal receipt when payment succeeds
- User email is already available from JWT auth (`user.email` at line 103)
- Tax parameters are unknown to the user — using safe defaults (УСН / Без НДС), extracted as constants for easy change later
- Webhook verification is already adequate (API-based verification at `payment-webhook/index.ts:54-80`)

## Solution

### Single file change: `supabase/functions/create-payment/index.ts`

**Step 1**: Add fiscal receipt constants at the top (after line 60):

```typescript
// Fiscal receipt configuration (54-FZ)
// tax_system_code: 1=ОСН, 2=УСН(доходы), 3=УСН(доходы-расходы), 4=ЕНВД, 5=ЕСХН, 6=ПСН
const RECEIPT_TAX_SYSTEM_CODE = 2  // УСН (доходы) — change if different

// vat_code: 1=Без НДС, 2=НДС 0%, 3=НДС 10%, 4=НДС 20%, 5=НДС 10/110, 6=НДС 20/120
const RECEIPT_VAT_CODE = 1  // Без НДС — standard for УСН
```

**Step 2**: Add `receipt` field to `yukassaPayload` (lines 167-183):

```typescript
const yukassaPayload = {
  amount: {
    value: tariff.price.toFixed(2),
    currency: "RUB",
  },
  confirmation: {
    type: "embedded",
    return_url: paymentReturnUrl,
  },
  capture: true,
  description: `Symancy - ${tariff.name} (${tariff.description})`,
  receipt: {
    customer: {
      email: user.email,  // already available from line 103
    },
    items: [
      {
        description: `${tariff.name} — ${tariff.description}`,
        quantity: "1.00",
        amount: {
          value: tariff.price.toFixed(2),
          currency: "RUB",
        },
        vat_code: RECEIPT_VAT_CODE,
        payment_mode: "full_payment",
        payment_subject: "service",
      },
    ],
    tax_system_code: RECEIPT_TAX_SYSTEM_CODE,
  },
  metadata: {
    user_id: userId,
    product_type: product_type,
    purchase_id: purchaseId,
  },
}
```

Key receipt fields per YooKassa API docs:
- `customer.email` — email for sending the fiscal receipt to user
- `items[].description` — tariff name (max 128 chars)
- `items[].quantity` — "1.00" (single digital service)
- `items[].amount` — matches payment amount
- `items[].vat_code` — 1 (Без НДС for УСН)
- `items[].payment_mode` — "full_payment" (полная оплата)
- `items[].payment_subject` — "service" (оказание услуг)
- `tax_system_code` — 2 (УСН доходы)

## What we're NOT doing

- **No webhook changes** — API-based verification already implemented, YooKassa docs confirm this is a valid approach (alternative to IP whitelist)
- **No separate POST /v3/receipts call** — inline receipt is simpler and auto-generated by YooKassa
- **No IP whitelist for webhooks** — Supabase Edge Functions don't expose client IP easily; API verification is sufficient

## Critical File

| File | Change |
|------|--------|
| `supabase/functions/create-payment/index.ts` | Add receipt constants + receipt field to yukassaPayload |

## Verification

1. Deploy edge function: `supabase functions deploy create-payment`
2. Test with test card `2202 4743 0132 2987` (successful payment)
3. Verify in YooKassa dashboard that the payment has a receipt attached
4. Test with cancellation card `2200 0000 0000 0053` — receipt should only be generated for successful payments
5. Check user's email — YooKassa should auto-send the fiscal receipt

## Notes for later

- When the tax system or VAT rate is confirmed by accountant, update `RECEIPT_TAX_SYSTEM_CODE` and `RECEIPT_VAT_CODE` constants
- If the business is a self-employed individual (самозанятый), the receipt format differs — use YooKassa's "Чеки для самозанятых" integration instead
