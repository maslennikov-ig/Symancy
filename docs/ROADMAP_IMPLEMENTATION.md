# Техническое задание на развитие платформы Symancy (Phases 0-5)

**Дата:** 18.12.2025
**Статус:** Approved
**База:** MVP (Web) -> Full Production (TMA)

---

## Фаза 0: Core Architecture & Migration (Приоритет: Критический)
**Цель:** Отказ от No-Code (n8n) в пользу надежного бэкенда, оптимизация и локализация.

### 0.1. Миграция бэкенда (n8n -> Supabase Edge Functions)
- **Задача:** Перенести логику анализа из n8n в функцию `supabase/functions/analyze-coffee`.
- **Реализация:**
  - Создание TypeScript-функции, работающей напрямую с OpenRouter API (или другим AI-провайдером).
  - **Безопасная цепочка:**
    1. Проверка JWT токена пользователя.
    2. Проверка баланса кредитов (DB query).
    3. Списание кредита и создание записи в истории (Transaction).
    4. Отправка запроса в AI.
    5. Сохранение результата в историю.
    6. Возврат ответа клиенту.
  - **Промпт-инжиниринг:** Перенос системных промптов "Арины" в код (или в БД для управления через админку).

### 0.2. Оптимизация изображений
- **Проблема:** Загрузка "тяжелых" фото (5-10 Мб) тратит трафик и замедляет AI.
- **Решение:** Client-side сжатие.
  - Внедрение `browser-image-compression`.
  - Параметры: Max width/height 1500px, quality 0.7 (цель < 500kb).
  - Конвертация в WebP перед отправкой.

### 0.3. Глобальная локализация (i18n)
- **Задача:** Избавиться от хардкода текстов.
- **Области:**
  - **Тарифы:** Названия, описания, преимущества (`Pricing.tsx`).
  - **Ошибки:** Сообщения от сервера и валидации.
  - **Интерфейс:** Мелкие подписи, футер, статусы.
- **Реализация:** Расширение словарей в `lib/i18n.ts`.

---

## Фаза 1: Deep Telegram Integration (TMA Native)
**Цель:** Обеспечить "бесшовный" вход и нативный UX.

### 1.1. Инициализация Telegram Web App
- Подключение SDK (`@twa-dev/sdk`).
- Синхронизация темы (`tg.themeParams`).
- Поддержка `BackButton` и `MainButton`.

### 1.2. Бесшовная авторизация
- Валидация `initData` на стороне Supabase.
- Автоматический вход/регистрация без пароля по Telegram ID.

---

## Фаза 2: Виральность и Социальные механики
**Цель:** Привлечение трафика через шеринг.

### 2.1. Генерация Share-контента
- Генерация красивой "карточки предсказания" (изображение с цитатой и фоном) на клиенте.
- Кнопка "Поделиться в Stories" (через `tg.shareUrl` или нативный метод).

### 2.2. Реферальная система
- Ссылки `t.me/buhbot?start=ref_ID`.
- Начисление бонусных кредитов за приглашения.

---

## Фаза 3: Retention и Геймификация
**Цель:** Удержание пользователей.

### 3.1. Дневник настроения (Mood Diary)
- Сбор фидбека после гадания (оценка эмоций).
- Графики настроения в профиле.

### 3.2. Система достижений
- Бейджи за активность (1-е гадание, 10-е гадание и т.д.).

---

## Фаза 4: Администрирование и Аналитика
**Цель:** Управление бизнесом.

### 4.1. Панель администратора
- Просмотр транзакций, пользователей.
- Ручное управление кредитами.

### 4.2. Продвинутая аналитика
- Интеграция PostHog (воронки продаж, конверсии).

---

## Стек технологий

| Компонент | Было (MVP) | Станет (Production) |
|-----------|------------|---------------------|
| **AI Orchestration** | n8n Webhook | **Supabase Edge Functions** |
| **Images** | Raw Upload | **Client-side Compression** |
| **Auth** | Email/Pass | **Telegram Native (initData)** |
| **Language** | Частичный i18n | **Полный i18n** |

---

## План работ (Timeline Update)

1.  **Фаза 0:** Миграция бэкенда и рефакторинг. (1-1.5 недели)
2.  **Фаза 1:** Интеграция с Telegram. (1 неделя)
3.  **Фаза 2-4:** Фичи роста и админка. (по очереди)