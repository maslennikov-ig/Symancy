# Гайд по тестированию платежей Symancy

## Быстрый старт

### 1. Откройте тестовую страницу

```
https://symancy.ru/test-payment
```

### 2. Авторизуйтесь

1. Введите ваш email
2. Нажмите "Войти"
3. Проверьте почту — придёт ссылка для входа
4. Перейдите по ссылке

### 3. Выберите тариф

На странице 4 тарифа:

| Тариф | Цена | Кредиты |
|-------|------|---------|
| Новичок | 100 ₽ | 1 |
| Любитель | 300 ₽ | 5 |
| Внутренний мудрец | 500 ₽ | 1 |
| Кассандра | 1000 ₽ | 1 |

Нажмите на любой тариф.

### 4. Оплатите тестовой картой

| Поле | Значение |
|------|----------|
| **Номер карты** | `4111 1111 1111 1111` |
| **Срок действия** | Любая дата в будущем (например, `12/25`) |
| **CVV** | Любые 3 цифры (например, `123`) |

> Это тестовая карта YooKassa. Реальные деньги НЕ списываются.

### 5. Подтвердите платёж

После ввода данных карты нажмите "Оплатить".

---

## Проверка результата

### В интерфейсе

После успешной оплаты вы увидите сообщение:
```
Платёж успешно завершён! Проверьте базу данных.
```

---

## Тестовые сценарии

### Сценарий 1: Успешная оплата (Visa)

1. Выберите тариф "Новичок" (100 ₽)
2. Введите карту `4111 1111 1111 1111`
3. Оплатите
4. **Ожидание**:
   - Сообщение об успехе
   - В `purchases` статус `succeeded`
   - В `user_credits` +1 basic_credits

### Сценарий 2: Успешная оплата (Mastercard)

1. Выберите любой тариф
2. Введите карту `5555 5555 5555 4444`
3. Оплатите
4. **Ожидание**:
   - Платёж проходит успешно

### Сценарий 3: 3D Secure (Mastercard)

1. Выберите любой тариф
2. Введите карту `5555 5555 5555 4477`
3. Оплатите
4. **Ожидание**:
   - Появится окно 3D Secure
   - После подтверждения — успешная оплата

### Сценарий 4: 3D Secure (Visa)

1. Выберите любой тариф
2. Введите карту `4793 1281 6164 4804`
3. Оплатите
4. **Ожидание**:
   - Появится окно 3D Secure
   - После подтверждения — успешная оплата

### Сценарий 5: Карта Мир

1. Выберите любой тариф
2. Введите карту `2202 4743 0132 2987`
3. Оплатите
4. **Ожидание**:
   - Платёж проходит успешно

### Сценарий 6: Недостаточно средств

1. Выберите любой тариф
2. Введите карту `5555 5555 5555 4600` (Mastercard)
3. Оплатите
4. **Ожидание**:
   - Платёж отклонён
   - В `purchases` статус `canceled`
   - Причина: `insufficient_funds`

### Сценарий 7: Карта просрочена

1. Выберите любой тариф
2. Введите карту `5555 5555 5555 4543` (Mastercard)
3. Оплатите
4. **Ожидание**:
   - Платёж отклонён
   - Причина: `card_expired`

### Сценарий 8: Общий отказ банка

1. Выберите любой тариф
2. Введите карту `5555 5555 5555 4527` (Mastercard)
3. Оплатите
4. **Ожидание**:
   - Платёж отклонён
   - Причина: `general_decline`

---

## Официальные тестовые карты YooKassa

### Успешная оплата (без 3D Secure)

| Платёжная система | Номер карты |
|-------------------|-------------|
| Visa | `4111 1111 1111 1111` |
| Visa Electron | `4175 0010 0000 0017` |
| Mastercard | `5555 5555 5555 4444` |
| Maestro | `6759 6491 6164 4804` |
| Мир | `2202 4743 0132 2987` |
| American Express | `3700 0000 0000 002` |
| JCB | `3528 0007 0000 0000` |
| Diners Club | `3670 0102 0000 00` |

### С 3D Secure аутентификацией

| Платёжная система | Номер карты |
|-------------------|-------------|
| Mastercard | `5555 5555 5555 4477` |
| Visa | `4793 1281 6164 4804` |
| Мир | `2200 0000 0000 0004` |

### Карты для симуляции ошибок

| Ошибка | Mastercard | Visa | Мир |
|--------|------------|------|-----|
| Недостаточно средств | `5555 5555 5555 4600` | `4562 2655 8771 2390` | `2200 0000 0000 0053` |
| Карта просрочена | `5555 5555 5555 4543` | `4141 4354 1263 0840` | `2200 0000 0000 0038` |
| Подозрение на мошенничество | `5555 5555 5555 4568` | `4483 2742 8229 9972` | `2200 0000 0000 0046` |
| Общий отказ банка | `5555 5555 5555 4527` | `4889 9717 0658 8753` | `2202 2022 1231 2379` |

### Для всех карт

- **Срок действия**: любая дата в будущем (например, `12/25`)
- **CVV/CVC**: любые 3 цифры (например, `123`)
- **Имя держателя**: любое (например, `TEST USER`)

---

## Важно

> **Карты Stripe НЕ работают с YooKassa!**
>
> Карты вида `4000 0000 0000 XXXX` — это тестовые карты Stripe.
> Для YooKassa используйте только карты из таблиц выше.

---

## Возможные проблемы

### Ошибка "Not authenticated"

**Причина**: Не авторизованы или истёк токен

**Решение**:
1. Обновите страницу
2. Авторизуйтесь заново

### Ошибка "Payment creation failed"

**Причина**: Проблема с API YooKassa или секретами

**Решение**:
1. Проверьте, что в Supabase установлены секреты:
   - `YUKASSA_SHOP_ID`
   - `YUKASSA_SECRET_KEY`
2. Проверьте логи Edge Function в Supabase Dashboard

### Платёж прошёл, но кредиты не начислены

**Причина**: Webhook не сработал

**Решение**:
1. Проверьте, что в тестовом магазине YooKassa настроен webhook URL:
   ```
   https://johspxgvkbrysxhilmbg.supabase.co/functions/v1/payment-webhook
   ```
2. Проверьте логи `payment-webhook` в Supabase Dashboard

### Ошибка "Технический сбой" при 3D Secure

**Причина**: Проблема с return_url для 3D Secure

**Решение**: Исправлено в версии create-payment v5. Если проблема повторяется:
1. Проверьте, что Edge Function `create-payment` обновлена до последней версии
2. Проверьте логи в Supabase Dashboard

### Настройка редиректов (Local + Prod)

Чтобы ссылки из писем работали и на компьютере, и на сайте:

1. Зайдите в [Supabase Dashboard](https://supabase.com/dashboard/project/johspxgvkbrysxhilmbg) -> Authentication -> URL Configuration.
2. Установите **Site URL**: `https://symancy.ru`.
3. В **Redirect URLs** добавьте два адреса:
   - `https://symancy.ru/**`
   - `http://localhost:5173/**` (для локальной разработки)

---

## Ссылки

- [Документация YooKassa: тестирование](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- [Supabase Dashboard](https://supabase.com/dashboard/project/johspxgvkbrysxhilmbg)

---

## Контакты

При возникновении проблем:
- Email: support@symancy.ru
- Telegram: @symancy_support
