# YooKassa: Чеклист переключения в боевой режим

**Дата:** 17 февраля 2026
**Статус:** В работе
**Задачи Beads:** sym-157, sym-20s, sym-4mr

---

## Общая схема

```
СЕЙЧАС (тестовый режим):
  Web App → create-payment (Edge Function) → YooKassa TEST API → тестовые карты
  YooKassa TEST → payment-webhook (Edge Function) → начисление кредитов

ЦЕЛЬ (боевой режим):
  Web App → create-payment (Edge Function) → YooKassa LIVE API → реальные карты + СБП
  YooKassa LIVE → payment-webhook (Edge Function) → начисление кредитов
```

Код edge functions **один и тот же** — меняются только credentials (shopId + secretKey) и настройки в ЛК YooKassa.

---

## Часть 1: Что должен сделать настройщик YooKassa (заказчик/администратор)

### 1.1. Пройти верификацию магазина (если ещё не пройдена)

YooKassa не даёт боевые ключи без верификации. Нужно:

- [ ] Войти в [ЛК YooKassa](https://yookassa.ru/my/) → раздел "Боевой магазин"
- [ ] Загрузить документы ИП (если запрошены):
  - Свидетельство о регистрации ИП (ОГРНИП)
  - Паспорт
  - Договор на обработку платежей (генерируется в ЛК)
- [ ] Дождаться одобрения (обычно 1-3 рабочих дня)
- [ ] Убедиться, что статус магазина = **"Активен"**

> Если магазин уже верифицирован и активен — пропустить этот шаг.

### 1.2. Включить "Чеки от ЮKassa" в боевом магазине

> Подробная инструкция: `docs/YOOKASSA-RECEIPTS-GUIDE.md`

- [ ] Переключиться на **боевой магазин** (переключатель вверху ЛК)
- [ ] Перейти: **Настройки** → **Онлайн-касса** (или "54-ФЗ")
- [ ] Включить **"Чеки от ЮKassa"**
- [ ] Заполнить параметры:

| Поле | Значение |
|------|----------|
| Система налогообложения | Уточнить у бухгалтера (скорее всего **УСН доходы**) |
| Адрес расчёта | `https://symancy.ru` |
| Email для ошибок чеков | `support@symancy.ru` (или ваш email) |
| Связь платежа и чека | **"Принять платёж"** |

### 1.3. Настроить webhook в боевом магазине

- [ ] Переключиться на **боевой магазин**
- [ ] Перейти: **Интеграция** → **HTTP-уведомления**
- [ ] Добавить новый webhook:

| Поле | Значение |
|------|----------|
| URL | `https://johspxgvkbrysxhilmbg.supabase.co/functions/v1/payment-webhook` |
| События | `payment.succeeded` и `payment.canceled` |

- [ ] Сохранить

### 1.4. Получить боевые API-ключи

- [ ] Перейти: **Интеграция** → **Ключи API** (в боевом магазине)
- [ ] Скопировать и **безопасно передать разработчику**:

```
shopId:    _______________  (числовой идентификатор магазина)
secretKey: live_____________  (начинается с "live_", НЕ "test_")
```

> **Важно:** Передавать только через защищённый канал (личное сообщение, зашифрованный чат). Не через email и не в общий чат.

### 1.5. Проверить настройки способов оплаты

- [ ] Перейти: **Настройки** → **Способы оплаты** (в боевом магазине)
- [ ] Убедиться, что включены:
  - [x] Банковские карты (Visa, Mastercard, Мир)
  - [ ] **СБП** (Система Быстрых Платежей) — включить, если не включен
  - [ ] Apple Pay / Google Pay (опционально, если доступны)
  - [ ] ЮMoney (электронный кошелёк, опционально)

> СБП обычно включается автоматически. Если не видите — обратитесь в поддержку YooKassa.

### 1.6. Итоговый чеклист для передачи разработчику

```
Передать разработчику:

1. Боевой shopId:          _______________
2. Боевой secretKey:       live_____________
3. Чеки от ЮKassa:         [ ] Включены
4. СНО для чеков:          _______________  (УСН доходы / УСН доходы-расходы / ...)
5. Ставка НДС:             _______________  (Без НДС / 5% / 20%)
6. Webhook настроен:       [ ] Да
7. СБП включён:            [ ] Да
8. Статус магазина:         [ ] Активен
```

---

## Часть 2: Что должен сделать разработчик (код)

### 2.1. Обновить secrets в Supabase

Заменить тестовые ключи на боевые:

```bash
# Установить боевые credentials
supabase secrets set YUKASSA_SHOP_ID=<БОЕВОЙ_SHOP_ID>
supabase secrets set YUKASSA_SECRET_KEY=<БОЕВОЙ_SECRET_KEY>
```

**Текущие переменные окружения в Edge Functions:**

| Переменная | Где используется | Что менять |
|------------|-----------------|------------|
| `YUKASSA_SHOP_ID` | `create-payment/index.ts`, `payment-webhook/index.ts` | Заменить тестовый на боевой |
| `YUKASSA_SECRET_KEY` | `create-payment/index.ts`, `payment-webhook/index.ts` | Заменить `test_*` на `live_*` |
| `YUKASSA_WEBHOOK_SECRET` | Не используется в коде (верификация через API) | Опционально |

> Код НЕ нужно менять — он одинаковый для тестового и боевого режима. Меняются только secrets.

### 2.2. Проверить параметры фискальных чеков в коде

Файл: `supabase/functions/create-payment/index.ts` (строки 63-67)

```typescript
// Текущие значения — проверить, что совпадают с настройками в ЛК:
const RECEIPT_TAX_SYSTEM_CODE = 2  // 2 = УСН (доходы)
const RECEIPT_VAT_CODE = 1         // 1 = Без НДС
```

| Код | Значение |
|-----|----------|
| `tax_system_code = 1` | ОСН |
| `tax_system_code = 2` | **УСН (доходы)** ← текущее |
| `tax_system_code = 3` | УСН (доходы минус расходы) |
| `tax_system_code = 6` | ПСН (патент) |
| `vat_code = 1` | **Без НДС** ← текущее |
| `vat_code = 4` | НДС 20% |

> Если бухгалтер скажет, что СНО или НДС другие — нужно обновить эти константы и задеплоить.

### 2.3. Задеплоить Edge Functions

```bash
# Деплой обеих функций
supabase functions deploy create-payment
supabase functions deploy payment-webhook
```

> Если код функций не менялся с последнего деплоя, и только secrets обновились — деплоить не обязательно. Secrets применяются без редеплоя.

### 2.4. Проверить CORS и return_url

Файл: `supabase/functions/create-payment/index.ts` (строка 169)

```typescript
const origin = return_url
  ? new URL(return_url).origin
  : "https://symancy.ru"  // ← правильный production URL
```

- [x] `return_url` по умолчанию = `https://symancy.ru` — корректно
- [ ] Проверить, что `https://symancy.ru/payment/result` страница работает

### 2.5. Провести тестовый реальный платёж

- [ ] Открыть `https://symancy.ru/test-payment`
- [ ] Авторизоваться
- [ ] Купить самый дешёвый тариф "Новичок" (100 руб.) **реальной картой**
- [ ] Проверить:
  - [ ] Платёж прошёл успешно
  - [ ] Webhook сработал (проверить логи Edge Function в Supabase Dashboard)
  - [ ] Кредиты начислены (проверить таблицу `user_credits`)
  - [ ] Запись в `purchases` со статусом `succeeded`
  - [ ] Фискальный чек пришёл на email
  - [ ] Запись в `payment_analytics`
- [ ] Проверить СБП:
  - [ ] Начать оплату
  - [ ] Выбрать способ оплаты "СБП" (если доступен в виджете YooKassa)
  - [ ] Оплатить через мобильный банк
  - [ ] Проверить начисление кредитов
- [ ] Проверить сценарии ошибок:
  - [ ] Попробовать оплату с недостаточно средств
  - [ ] Проверить, что статус `canceled` корректно записывается

### 2.6. Убрать тестовую страницу (опционально)

После подтверждения работоспособности:

- [ ] Решить: оставить `/test-payment` для внутреннего тестирования или удалить
- [ ] Если удалять: убрать маршрут из роутера

---

## Часть 3: Чеклист готовности

### До переключения:

| # | Проверка | Кто | Статус |
|---|----------|-----|--------|
| 1 | Магазин верифицирован и активен | Заказчик | [ ] |
| 2 | Чеки от ЮKassa включены (боевой) | Заказчик | [ ] |
| 3 | СНО и НДС уточнены у бухгалтера | Заказчик | [ ] |
| 4 | Webhook настроен (боевой) | Заказчик | [ ] |
| 5 | Боевые ключи переданы разработчику | Заказчик | [ ] |
| 6 | Secrets обновлены в Supabase | Разработчик | [ ] |
| 7 | Параметры чеков в коде совпадают с ЛК | Разработчик | [ ] |
| 8 | Edge Functions задеплоены | Разработчик | [ ] |

### После переключения:

| # | Проверка | Кто | Статус |
|---|----------|-----|--------|
| 9 | Тестовый платёж 100 руб. прошёл | Разработчик | [ ] |
| 10 | Кредиты начислены | Разработчик | [ ] |
| 11 | Фискальный чек пришёл на email | Заказчик | [ ] |
| 12 | СБП работает | Разработчик | [ ] |
| 13 | Отменённый платёж корректно обрабатывается | Разработчик | [ ] |
| 14 | Страница `/payment/result` работает | Разработчик | [ ] |

---

## Возможные проблемы

### "Магазин не активен" / "Невозможно создать платёж"

**Причина:** Боевой магазин не прошёл верификацию.
**Решение:** Связаться с поддержкой YooKassa, загрузить требуемые документы.

### Webhook не приходит

**Причина:** Webhook URL не настроен или настроен для тестового магазина.
**Решение:** Проверить настройки в ЛК YooKassa → Боевой магазин → Интеграция → HTTP-уведомления.

### Чек не пришёл

**Причина:** "Чеки от ЮKassa" не включены в боевом магазине, или email пользователя не передаётся.
**Решение:** Проверить настройки 54-ФЗ в ЛК и наличие `user.email` в коде (`create-payment/index.ts:188`).

### "Forbidden" при создании платежа

**Причина:** Используются тестовые ключи (`test_*`) с боевым API или наоборот.
**Решение:** Убедиться, что `YUKASSA_SECRET_KEY` начинается с `live_`.

### СБП не отображается как способ оплаты

**Причина:** СБП не включён в настройках магазина.
**Решение:** ЛК YooKassa → Настройки → Способы оплаты → включить СБП. Если нет такой опции — обратиться в поддержку.

---

## Контакты

### Поддержка YooKassa
- Чат в ЛК (правый нижний угол)
- Email: merchants@yookassa.ru
- Телефон: 8 800 250-66-99

### Полезные ссылки
- [Документация: переход в боевой режим](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/going-live)
- [Тестирование платежей](https://yookassa.ru/developers/payment-acceptance/testing-and-going-live/testing)
- [Чеки от ЮKassa](https://yookassa.ru/developers/payment-acceptance/receipts/54fz/yookassa-receipts)
- [Supabase Dashboard (логи функций)](https://supabase.com/dashboard/project/johspxgvkbrysxhilmbg)

---

## Связанные документы

- `docs/YOOKASSA-RECEIPTS-GUIDE.md` — подробная инструкция по настройке чеков
- `docs/PAYMENT-TESTING-GUIDE.md` — тестовые карты и сценарии
- `supabase/functions/create-payment/index.ts` — Edge Function создания платежа
- `supabase/functions/payment-webhook/index.ts` — Edge Function обработки webhook
- `supabase/.env.example` — шаблон переменных окружения
