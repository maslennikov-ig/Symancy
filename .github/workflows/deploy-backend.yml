name: Deploy Backend to Production

on:
  push:
    branches:
      - main
    paths:
      - 'symancy-backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (emergency deploy)'
        type: boolean
        default: false

env:
  NODE_VERSION: '22'
  BACKEND_DIR: 'symancy-backend'
  TARGET_ROOT: '/var/www/symancy-backend'

jobs:
  # Gate 1: Security Audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: '${{ env.BACKEND_DIR }}/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: pnpm audit --audit-level=critical || echo "::warning::Critical vulnerabilities found!"

  # Gate 2: Type Check & Build
  build:
    name: Build & Type Check
    runs-on: ubuntu-latest
    needs: [security]
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: '${{ env.BACKEND_DIR }}/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Type check
        run: pnpm type-check

      - name: Build project
        run: pnpm build

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dist
          path: |
            ${{ env.BACKEND_DIR }}/dist/
            ${{ env.BACKEND_DIR }}/prompts/
            ${{ env.BACKEND_DIR }}/package.json
            ${{ env.BACKEND_DIR }}/pnpm-lock.yaml
            ${{ env.BACKEND_DIR }}/ecosystem.config.cjs
          retention-days: 1

  # Gate 3: Tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ !inputs.skip_tests }}
    defaults:
      run:
        working-directory: ${{ env.BACKEND_DIR }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: '${{ env.BACKEND_DIR }}/pnpm-lock.yaml'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test:unit || echo "::warning::Some tests failed"

  # Deploy to Production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, test]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    environment: production
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dist
          path: backend-dist/

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy to server
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          RELEASE_DATE=$(date +%Y%m%d%H%M%S)
          RELEASE_DIR="${TARGET_ROOT}/releases/${RELEASE_DATE}"

          echo "Deploying backend to ${RELEASE_DIR}..."

          # Create release directory
          ssh ${SSH_USER}@${SSH_HOST} "mkdir -p ${RELEASE_DIR}"

          # Upload build artifacts (artifact root is symancy-backend/, so files are in backend-dist/)
          scp -r backend-dist/* ${SSH_USER}@${SSH_HOST}:${RELEASE_DIR}/

          # Install production dependencies on server
          ssh ${SSH_USER}@${SSH_HOST} "cd ${RELEASE_DIR} && pnpm install --frozen-lockfile --prod"

          # Create symlink to current release
          ssh ${SSH_USER}@${SSH_HOST} "ln -sfn ${RELEASE_DIR} ${TARGET_ROOT}/current"

          # Reload PM2 (graceful restart)
          ssh ${SSH_USER}@${SSH_HOST} "cd ${TARGET_ROOT}/current && pm2 reload ecosystem.config.cjs --env production || pm2 start ecosystem.config.cjs --env production"

          # Save PM2 process list
          ssh ${SSH_USER}@${SSH_HOST} "pm2 save"

          # Cleanup old releases (keep last 5)
          ssh ${SSH_USER}@${SSH_HOST} "cd ${TARGET_ROOT}/releases && ls -t | tail -n +6 | xargs -r rm -rf"

          echo "Backend deployment complete!"

      - name: Verify deployment
        env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
        run: |
          echo "Waiting for service to start..."
          sleep 10

          # Check health endpoint
          HEALTH_STATUS=$(ssh ${SSH_USER}@${SSH_HOST} "curl -sf http://localhost:3000/health | jq -r '.status'" || echo "failed")

          if [ "$HEALTH_STATUS" = "ok" ] || [ "$HEALTH_STATUS" = "degraded" ]; then
            echo "Health check passed: ${HEALTH_STATUS}"
          else
            echo "::error::Health check failed: ${HEALTH_STATUS}"
            exit 1
          fi

  # Notify: Telegram
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          COMMIT_SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "$DEPLOY_RESULT" == "success" ]; then
            MESSAGE="Backend Deploy%0A%0ASUCCESS%0A%0ACommit: \`${COMMIT_SHA:0:7}\`%0AAuthor: $ACTOR%0A[View on GitHub]($RUN_URL)"
          else
            MESSAGE="Backend Deploy%0A%0AFAILED%0A%0ACommit: \`${COMMIT_SHA:0:7}\`%0AAuthor: $ACTOR%0A[View logs]($RUN_URL)"
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "parse_mode=Markdown" \
            -d "disable_web_page_preview=true" \
            -d "text=${MESSAGE}" || true
